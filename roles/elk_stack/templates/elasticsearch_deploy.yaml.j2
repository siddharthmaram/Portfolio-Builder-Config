apiVersion: apps/v1
kind: StatefulSet
metadata:
    name: {{ es_statefulset_name }}
    namespace: {{ es_namespace }}
    labels:
        app: elasticsearch
spec:
    serviceName: {{ es_service_name }}
    replicas: {{ es_replicas }}
    selector:
        matchLabels:
            app: elasticsearch
    template:
        metadata:
            labels:
                app: elasticsearch
        spec:
            containers:
                - name: elasticsearch
                  image: {{ es_image }}
                  resources:
                      requests:
                          memory: "2Gi"
                          cpu: "500m"
                      limits:
                          memory: "4Gi"
                          cpu: "1"
                  ports:
                    - containerPort: {{ es_port_http }}
                      name: http
                  env:
                    - name: discovery.type
                      value: "single-node"
                    
                    - name: ES_JAVA_OPTS
                      value: "-Xms1g -Xmx1g"
                  securityContext:
                      capabilities:
                        add: ["IPC_LOCK"]
                      runAsUser: 1000
                  volumeMounts:
                    - name: elasticsearch-data
                      mountPath: /usr/share/elasticsearch/data
            
            initContainers:
                - name: increase-vm-max-map
                  image: busybox
                  command: ['sysctl', '-w', 'vm.max_map_count=262144']
                  securityContext:
                    privileged: true

    volumeClaimTemplates:
        - metadata:
            name: elasticsearch-data
          spec:
            accessModes: ["ReadWriteOnce"]
            resources:
              requests:
                storage: 10Gi
                  
