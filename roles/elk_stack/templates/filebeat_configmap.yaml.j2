apiVersion: v1
kind: ConfigMap
metadata:
  name: filebeat-config
  namespace: {{ es_namespace }}
  labels:
    k8s-app: filebeat
data:
  filebeat.yml: |-
    logging.level: info
    logging.to_files: false
    logging.to_stderr: true

    # ---------------------------
    # INPUT: Kubernetes containers
    # ---------------------------
    filebeat.inputs:
      - type: container
        enabled: true
        paths:
          - /var/log/containers/*.log

        # Let Filebeat unwrap the Docker/CRI JSON wrapper
        # and DO NOT attach json errors into the event
        json.keys_under_root: true
        json.add_error_key: false       # <- changed from true
        json.message_key: log
        json.ignore_decoding_error: true

    # ---------------------------
    # PROCESSORS
    # ---------------------------
    processors:
      # Add Kubernetes metadata
      - add_kubernetes_metadata:
          host: ${NODE_NAME}
          in_cluster: true
          matchers:
            - logs_path:
                logs_path: "/var/log/containers/"

      # Optionally decode JSON from app logs
      # Only if your app *actually* writes JSON to stdout.
      # If it does NOT, comment this whole processor out.
      - decode_json_fields:
          fields: ["message"]
          target: ""
          overwrite_keys: true
          add_error_key: true
          max_depth: 2
          when:
            regexp:
              message: '^\s*\{'

    # ---------------------------
    # SETUP
    # ---------------------------
    setup.template.name: "filebeat"
    setup.template.pattern: "filebeat-*"
    setup.ilm.enabled: false
    setup.template.settings:
      index.number_of_shards: 1

    setup.kibana:
      host: "kibana-service.{{ es_namespace }}.svc.cluster.local:{{ kibana_port }}"
      enabled: true

    # ---------------------------
    # OUTPUT
    # ---------------------------
    output.logstash:
      # Point to the Service created in step 1
      hosts: ["logstash-service.{{ es_namespace }}.svc.cluster.local:5044"]