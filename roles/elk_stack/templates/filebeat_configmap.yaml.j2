apiVersion: v1
kind: ConfigMap
metadata:
  name: filebeat-config
  namespace: {{ es_namespace }}
  labels:
    k8s-app: filebeat
data:
  filebeat.yml: |-
    logging.level: info
    logging.to_files: false
    logging.to_stderr: true

    # ---------------------------
    # INPUT: Kubernetes containers
    # ---------------------------
    filebeat.inputs:
      - type: container
        enabled: true
        paths:
          - /var/log/containers/*.log

        # Keep these! They unwrap the Docker/CRI wrapper
        json.keys_under_root: true
        json.add_error_key: false 
        json.message_key: log
        json.ignore_decoding_error: true

    # ---------------------------
    # PROCESSORS
    # ---------------------------
    processors:
      # KEEP THIS: Filebeat is best at tagging K8s metadata
      - add_kubernetes_metadata:
          host: ${NODE_NAME}
          in_cluster: true
          matchers:
            - logs_path:
                logs_path: "/var/log/containers/"

      # REMOVED: decode_json_fields (Moved to Logstash)

    # ---------------------------
    # SETUP
    # ---------------------------
    setup.template.name: "filebeat"
    setup.template.pattern: "filebeat-*"
    setup.ilm.enabled: false
    setup.template.settings:
      index.number_of_shards: 1

    setup.kibana:
      host: "kibana-service.{{ es_namespace }}.svc.cluster.local:{{ kibana_port }}"
      enabled: true

    # ---------------------------
    # OUTPUT
    # ---------------------------
    output.logstash:
      hosts: ["logstash-service.{{ es_namespace }}.svc.cluster.local:5044"]